openapi: 3.0.3
info:
  title: Claude Monitor API
  description: |
    API para monitorear y gestionar sesiones de Claude Code CLI.

    ## Conceptos Clave

    - **Session Root**: Directorio donde se han ejecutado sesiones de Claude
    - **Session**: Una sesión de Claude Code con su historial de mensajes
    - **Terminal**: Una terminal PTY activa ejecutando Claude o shell
    - **Job**: Tarea programada para ejecución con Claude

    ## Comunicación en Tiempo Real

    Además de la API REST, el sistema ofrece:
    - **WebSocket**: Para I/O de terminal en tiempo real (`/api/terminals/{id}/ws`)
    - **Polling**: Para mensajes incrementales (`/api/.../messages/realtime`)
    - **Eventos Push**: Eventos de Claude via WebSocket (`claude:event`)

    ## Autenticación

    Actualmente la API no requiere autenticación (uso local).

  version: 1.0.0
  contact:
    name: Claude Monitor
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Servidor local de desarrollo

tags:
  - name: Health
    description: Endpoints de salud y disponibilidad
  - name: Host
    description: Información del servidor host
  - name: Session Roots
    description: Gestión de directorios con sesiones de Claude
  - name: Sessions
    description: Gestión de sesiones individuales de Claude
  - name: Terminals
    description: Gestión de terminales PTY activas
  - name: Jobs
    description: Sistema de tareas programadas
  - name: Analytics
    description: Estadísticas y métricas de uso
  - name: Filesystem
    description: Navegación del sistema de archivos

paths:
  # ==========================================================================
  # Health & Metrics
  # ==========================================================================
  /api/health:
    get:
      tags: [Health]
      summary: Health check
      description: Verifica que el servidor esté funcionando
      operationId: getHealth
      responses:
        '200':
          description: Servidor saludable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/ready:
    get:
      tags: [Health]
      summary: Readiness check
      description: Verifica que el servidor esté listo para recibir requests
      operationId: getReady
      responses:
        '200':
          description: Servidor listo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadyResponse'

  /metrics:
    get:
      tags: [Health]
      summary: Prometheus metrics
      description: Métricas en formato Prometheus
      operationId: getMetrics
      responses:
        '200':
          description: Métricas Prometheus
          content:
            text/plain:
              schema:
                type: string

  # ==========================================================================
  # Host
  # ==========================================================================
  /api/host:
    get:
      tags: [Host]
      summary: Información del host
      description: Retorna información del servidor y estado general
      operationId: getHost
      responses:
        '200':
          description: Información del host
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HostInfo'

  # ==========================================================================
  # Session Roots
  # ==========================================================================
  /api/session-roots:
    get:
      tags: [Session Roots]
      summary: Listar session roots
      description: Lista todos los directorios donde se han ejecutado sesiones de Claude
      operationId: listSessionRoots
      responses:
        '200':
          description: Lista de session roots
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionRootListResponse'

  /api/session-roots/{rootPath}:
    get:
      tags: [Session Roots]
      summary: Obtener session root
      description: Obtiene detalles de un session root específico
      operationId: getSessionRoot
      parameters:
        - $ref: '#/components/parameters/rootPath'
      responses:
        '200':
          description: Detalles del session root
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionRootResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Session Roots]
      summary: Eliminar session root
      description: Elimina un session root del registro (no elimina archivos)
      operationId: deleteSessionRoot
      parameters:
        - $ref: '#/components/parameters/rootPath'
      responses:
        '200':
          $ref: '#/components/responses/Success'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/session-roots/{rootPath}/activity:
    get:
      tags: [Session Roots]
      summary: Actividad del session root
      description: Obtiene métricas de actividad reciente
      operationId: getSessionRootActivity
      parameters:
        - $ref: '#/components/parameters/rootPath'
      responses:
        '200':
          description: Actividad del session root
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityResponse'

  # ==========================================================================
  # Sessions
  # ==========================================================================
  /api/session-roots/{rootPath}/sessions:
    get:
      tags: [Sessions]
      summary: Listar sesiones
      description: Lista todas las sesiones de Claude en un session root
      operationId: listSessions
      parameters:
        - $ref: '#/components/parameters/rootPath'
      responses:
        '200':
          description: Lista de sesiones
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionListResponse'

  /api/session-roots/{rootPath}/sessions/delete:
    post:
      tags: [Sessions]
      summary: Eliminar múltiples sesiones
      description: Elimina varias sesiones a la vez
      operationId: deleteMultipleSessions
      parameters:
        - $ref: '#/components/parameters/rootPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [session_ids]
              properties:
                session_ids:
                  type: array
                  items:
                    type: string
                  description: IDs de sesiones a eliminar
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/session-roots/{rootPath}/sessions/clean:
    post:
      tags: [Sessions]
      summary: Limpiar sesiones vacías
      description: Elimina sesiones que no tienen mensajes
      operationId: cleanEmptySessions
      parameters:
        - $ref: '#/components/parameters/rootPath'
      responses:
        '200':
          description: Resultado de limpieza
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      cleaned:
                        type: integer
                        description: Número de sesiones eliminadas

  /api/session-roots/{rootPath}/sessions/import:
    post:
      tags: [Sessions]
      summary: Importar sesiones
      description: Importa sesiones desde archivos JSONL del directorio de Claude
      operationId: importSessions
      parameters:
        - $ref: '#/components/parameters/rootPath'
      responses:
        '200':
          description: Resultado de importación
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      imported:
                        type: integer

  /api/session-roots/{rootPath}/sessions/{sessionID}:
    get:
      tags: [Sessions]
      summary: Obtener sesión
      description: Obtiene detalles de una sesión específica
      operationId: getSession
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/sessionID'
      responses:
        '200':
          description: Detalles de la sesión
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Sessions]
      summary: Eliminar sesión
      description: Elimina una sesión y su archivo JSONL
      operationId: deleteSession
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/sessionID'
      responses:
        '200':
          $ref: '#/components/responses/Success'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/session-roots/{rootPath}/sessions/{sessionID}/rename:
    put:
      tags: [Sessions]
      summary: Renombrar sesión
      description: Cambia el nombre de una sesión
      operationId: renameSession
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/sessionID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  description: Nuevo nombre para la sesión
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/session-roots/{rootPath}/sessions/{sessionID}/messages:
    get:
      tags: [Sessions]
      summary: Obtener mensajes
      description: Obtiene todos los mensajes de una sesión
      operationId: getSessionMessages
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/sessionID'
      responses:
        '200':
          description: Mensajes de la sesión
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessagesResponse'

  /api/session-roots/{rootPath}/sessions/{sessionID}/messages/realtime:
    get:
      tags: [Sessions]
      summary: Mensajes en tiempo real
      description: |
        Obtiene mensajes incrementales para polling eficiente.
        Usar el parámetro `from` para obtener solo mensajes nuevos.
      operationId: getRealtimeMessages
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/sessionID'
        - name: from
          in: query
          description: Índice desde donde obtener mensajes (0-based)
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Mensajes incrementales
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RealtimeMessagesResponse'

  # ==========================================================================
  # Terminals
  # ==========================================================================
  /api/terminals:
    get:
      tags: [Terminals]
      summary: Listar terminales
      description: Lista todas las terminales (activas y guardadas)
      operationId: listTerminals
      responses:
        '200':
          description: Lista de terminales
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TerminalListResponse'

    post:
      tags: [Terminals]
      summary: Crear terminal
      description: Crea una nueva terminal PTY (Claude o shell)
      operationId: createTerminal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TerminalConfig'
      responses:
        '201':
          description: Terminal creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TerminalResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/terminals/{terminalID}:
    get:
      tags: [Terminals]
      summary: Obtener terminal
      description: Obtiene detalles de una terminal
      operationId: getTerminal
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '200':
          description: Detalles de la terminal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TerminalResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Terminals]
      summary: Eliminar terminal
      description: Elimina una terminal del registro (debe estar detenida)
      operationId: deleteTerminal
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '200':
          $ref: '#/components/responses/Success'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/terminals/{terminalID}/ws:
    get:
      tags: [Terminals]
      summary: WebSocket de terminal
      description: |
        Conexión WebSocket para I/O de terminal en tiempo real.

        ## Mensajes del Servidor → Cliente

        | Tipo | Descripción |
        |------|-------------|
        | `output` | Salida raw de terminal (bytes PTY) |
        | `claude:event` | Evento específico de Claude |
        | `snapshot` | Estado inicial de pantalla al conectar |
        | `closed` | Terminal terminada |
        | `shutdown` | Servidor apagándose |

        ## Mensajes del Cliente → Servidor

        | Tipo | Descripción |
        |------|-------------|
        | `input` | Input para la terminal |
        | `resize` | Redimensionar terminal |

        ## Eventos Claude (`claude:event`)

        - `state`: Cambio de estado (waiting_input, generating, etc.)
        - `permission`: Solicitud de permiso para herramienta
        - `command`: Slash command detectado
        - `checkpoint`: Nuevo checkpoint creado
        - `tool`: Uso de herramienta (pre/post)

      operationId: terminalWebSocket
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '101':
          description: Switching Protocols (WebSocket upgrade)

  /api/terminals/{terminalID}/kill:
    post:
      tags: [Terminals]
      summary: Matar terminal
      description: Envía SIGTERM al proceso de la terminal
      operationId: killTerminal
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '200':
          $ref: '#/components/responses/Success'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/terminals/{terminalID}/resume:
    post:
      tags: [Terminals]
      summary: Reanudar terminal
      description: Reanuda una terminal Claude detenida
      operationId: resumeTerminal
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '200':
          description: Terminal reanudada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TerminalResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/terminals/{terminalID}/resize:
    post:
      tags: [Terminals]
      summary: Redimensionar terminal
      description: Cambia el tamaño de la terminal PTY
      operationId: resizeTerminal
      parameters:
        - $ref: '#/components/parameters/terminalID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [rows, cols]
              properties:
                rows:
                  type: integer
                  minimum: 1
                  description: Número de filas
                cols:
                  type: integer
                  minimum: 1
                  description: Número de columnas
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/terminals/{terminalID}/snapshot:
    get:
      tags: [Terminals]
      summary: Snapshot de pantalla
      description: Obtiene el estado actual de la pantalla de la terminal
      operationId: getTerminalSnapshot
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '200':
          description: Snapshot de la terminal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'

  /api/terminals/{terminalID}/claude-state:
    get:
      tags: [Terminals]
      summary: Estado de Claude
      description: Obtiene el estado actual de detección de Claude
      operationId: getClaudeState
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '200':
          description: Estado de Claude
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaudeStateResponse'
        '400':
          description: Terminal no es de tipo Claude
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/terminals/{terminalID}/checkpoints:
    get:
      tags: [Terminals]
      summary: Checkpoints de Claude
      description: Obtiene el historial de checkpoints de la sesión
      operationId: getClaudeCheckpoints
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '200':
          description: Lista de checkpoints
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckpointsResponse'

  /api/terminals/{terminalID}/events:
    get:
      tags: [Terminals]
      summary: Eventos de Claude
      description: Obtiene el historial de eventos detectados
      operationId: getClaudeEvents
      parameters:
        - $ref: '#/components/parameters/terminalID'
      responses:
        '200':
          description: Lista de eventos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'

  # ==========================================================================
  # Jobs
  # ==========================================================================
  /api/session-roots/{rootPath}/jobs:
    get:
      tags: [Jobs]
      summary: Listar jobs
      description: Lista todos los jobs de un session root
      operationId: listJobs
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - name: status
          in: query
          description: Filtrar por estado
          schema:
            $ref: '#/components/schemas/JobStatus'
      responses:
        '200':
          description: Lista de jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobListResponse'

    post:
      tags: [Jobs]
      summary: Crear job
      description: Crea un nuevo job para ejecución
      operationId: createJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobConfig'
      responses:
        '201':
          description: Job creado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'

  /api/session-roots/{rootPath}/jobs/{jobID}:
    get:
      tags: [Jobs]
      summary: Obtener job
      description: Obtiene detalles de un job
      operationId: getJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          description: Detalles del job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Jobs]
      summary: Eliminar job
      description: Elimina un job (debe estar archivado o pendiente)
      operationId: deleteJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          $ref: '#/components/responses/Success'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/session-roots/{rootPath}/jobs/{jobID}/start:
    post:
      tags: [Jobs]
      summary: Iniciar job
      description: Inicia la ejecución de un job pendiente
      operationId: startJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          $ref: '#/components/responses/Success'
        '400':
          description: Transición de estado inválida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/session-roots/{rootPath}/jobs/{jobID}/pause:
    post:
      tags: [Jobs]
      summary: Pausar job
      description: Pausa un job en ejecución
      operationId: pauseJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/session-roots/{rootPath}/jobs/{jobID}/resume:
    post:
      tags: [Jobs]
      summary: Reanudar job
      description: Reanuda un job pausado
      operationId: resumeJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/session-roots/{rootPath}/jobs/{jobID}/stop:
    post:
      tags: [Jobs]
      summary: Detener job
      description: Detiene un job en ejecución
      operationId: stopJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/session-roots/{rootPath}/jobs/{jobID}/archive:
    post:
      tags: [Jobs]
      summary: Archivar job
      description: Archiva un job completado o fallido
      operationId: archiveJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/session-roots/{rootPath}/jobs/{jobID}/retry:
    post:
      tags: [Jobs]
      summary: Reintentar job
      description: Reintenta un job que falló
      operationId: retryJob
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/session-roots/{rootPath}/jobs/{jobID}/discard:
    post:
      tags: [Jobs]
      summary: Descartar error
      description: Descarta el error de un job y lo marca como completado
      operationId: discardJobError
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/session-roots/{rootPath}/jobs/{jobID}/messages:
    get:
      tags: [Jobs]
      summary: Mensajes del job
      description: Obtiene los mensajes de la sesión asociada al job
      operationId: getJobMessages
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          description: Mensajes del job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessagesResponse'

  /api/session-roots/{rootPath}/jobs/{jobID}/actions:
    get:
      tags: [Jobs]
      summary: Acciones del job
      description: Obtiene el historial de acciones/transiciones del job
      operationId: getJobActions
      parameters:
        - $ref: '#/components/parameters/rootPath'
        - $ref: '#/components/parameters/jobID'
      responses:
        '200':
          description: Acciones del job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobActionsResponse'

  # ==========================================================================
  # Analytics
  # ==========================================================================
  /api/analytics/global:
    get:
      tags: [Analytics]
      summary: Analytics globales
      description: Obtiene estadísticas globales del sistema
      operationId: getGlobalAnalytics
      responses:
        '200':
          description: Analytics globales
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlobalAnalyticsResponse'

  /api/analytics/session-roots/{rootPath}:
    get:
      tags: [Analytics]
      summary: Analytics de session root
      description: Obtiene estadísticas de un session root específico
      operationId: getSessionRootAnalytics
      parameters:
        - $ref: '#/components/parameters/rootPath'
      responses:
        '200':
          description: Analytics del session root
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionRootAnalyticsResponse'

  /api/analytics/invalidate:
    post:
      tags: [Analytics]
      summary: Invalidar caché
      description: Invalida el caché de analytics
      operationId: invalidateAnalyticsCache
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                root_path:
                  type: string
                  description: Path específico a invalidar (opcional, si vacío invalida todo)
      responses:
        '200':
          $ref: '#/components/responses/Success'

  /api/analytics/cache:
    get:
      tags: [Analytics]
      summary: Estado del caché
      description: Obtiene el estado actual del caché de analytics
      operationId: getAnalyticsCacheStatus
      responses:
        '200':
          description: Estado del caché
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CacheStatusResponse'

  # ==========================================================================
  # Filesystem
  # ==========================================================================
  /api/filesystem/dir:
    get:
      tags: [Filesystem]
      summary: Listar directorio
      description: Lista el contenido de un directorio
      operationId: listDirectory
      parameters:
        - name: path
          in: query
          description: Path del directorio a listar
          schema:
            type: string
            default: /
      responses:
        '200':
          description: Contenido del directorio
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectoryListResponse'
        '400':
          description: Path no permitido o inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

# =============================================================================
# Components
# =============================================================================
components:
  # ---------------------------------------------------------------------------
  # Parameters
  # ---------------------------------------------------------------------------
  parameters:
    rootPath:
      name: rootPath
      in: path
      required: true
      description: Path del session root (URL encoded)
      schema:
        type: string
      example: "%2Fhome%2Fuser%2Fproject"

    sessionID:
      name: sessionID
      in: path
      required: true
      description: ID de la sesión (UUID)
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

    terminalID:
      name: terminalID
      in: path
      required: true
      description: ID de la terminal (UUID)
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

    jobID:
      name: jobID
      in: path
      required: true
      description: ID del job (UUID)
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

  # ---------------------------------------------------------------------------
  # Responses
  # ---------------------------------------------------------------------------
  responses:
    Success:
      description: Operación exitosa
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: true

    NotFound:
      description: Recurso no encontrado
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    BadRequest:
      description: Request inválido
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  # ---------------------------------------------------------------------------
  # Schemas
  # ---------------------------------------------------------------------------
  schemas:
    # -------------------------------------------------------------------------
    # Common
    # -------------------------------------------------------------------------
    ErrorResponse:
      type: object
      required: [success, error]
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Mensaje de error

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "ok"
        timestamp:
          type: string
          format: date-time

    ReadyResponse:
      type: object
      properties:
        ready:
          type: boolean
        checks:
          type: object
          properties:
            claude_cli:
              type: boolean
            data_dir:
              type: boolean

    # -------------------------------------------------------------------------
    # Host
    # -------------------------------------------------------------------------
    HostInfo:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            name:
              type: string
              description: Nombre del host
            version:
              type: string
              description: Versión de la API
            claude_dir:
              type: string
              description: Directorio de configuración de Claude
            active_terminals:
              type: integer
              description: Número de terminales activas
            total_sessions:
              type: integer
              description: Total de sesiones conocidas

    # -------------------------------------------------------------------------
    # Session Roots
    # -------------------------------------------------------------------------
    SessionRoot:
      type: object
      properties:
        path:
          type: string
          description: Path absoluto del directorio
        name:
          type: string
          description: Nombre del directorio
        session_count:
          type: integer
          description: Número de sesiones
        last_activity:
          type: string
          format: date-time
          description: Última actividad

    SessionRootListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/SessionRoot'
        meta:
          type: object
          properties:
            total:
              type: integer

    SessionRootResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/SessionRoot'

    ActivityResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            sessions_today:
              type: integer
            messages_today:
              type: integer
            tokens_today:
              type: integer
            cost_today:
              type: number
              format: float

    # -------------------------------------------------------------------------
    # Sessions
    # -------------------------------------------------------------------------
    Session:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        root_path:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        message_count:
          type: integer
        tokens_used:
          type: integer
        cost:
          type: number
          format: float
        model:
          type: string
        is_active:
          type: boolean

    SessionListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Session'
        meta:
          type: object
          properties:
            total:
              type: integer

    SessionResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Session'

    Message:
      type: object
      properties:
        type:
          type: string
          enum: [user, assistant, system, tool_use, tool_result]
        content:
          type: string
        timestamp:
          type: string
          format: date-time
        tokens:
          type: integer
        tool_name:
          type: string
        tool_id:
          type: string

    MessagesResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        meta:
          type: object
          properties:
            total:
              type: integer

    RealtimeMessagesResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        meta:
          type: object
          properties:
            total:
              type: integer
            from:
              type: integer
              description: Índice inicial
            has_more:
              type: boolean
              description: Si hay más mensajes disponibles

    # -------------------------------------------------------------------------
    # Terminals
    # -------------------------------------------------------------------------
    TerminalConfig:
      type: object
      required: [work_dir]
      properties:
        id:
          type: string
          format: uuid
          description: ID opcional (se genera si no se proporciona)
        name:
          type: string
          description: Nombre de la terminal
        work_dir:
          type: string
          description: Directorio de trabajo
        type:
          type: string
          enum: [claude, terminal]
          default: claude
          description: Tipo de terminal
        command:
          type: string
          description: Comando a ejecutar (solo para type=terminal)
        model:
          type: string
          description: Modelo de Claude a usar
          example: "claude-sonnet-4-20250514"
        system_prompt:
          type: string
          description: System prompt personalizado
        allowed_tools:
          type: array
          items:
            type: string
          description: Herramientas permitidas
        disallowed_tools:
          type: array
          items:
            type: string
          description: Herramientas prohibidas
        permission_mode:
          type: string
          enum: [default, plan, acceptEdits, dontAsk, bypassPermissions]
          description: Modo de permisos
        resume:
          type: boolean
          description: Reanudar sesión existente
        continue:
          type: boolean
          description: Continuar última sesión
        dangerously_skip:
          type: boolean
          description: Saltar confirmaciones de permisos

    Terminal:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        work_dir:
          type: string
        session_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [claude, terminal]
        status:
          type: string
          enum: [running, stopped]
        model:
          type: string
        active:
          type: boolean
        clients:
          type: integer
          description: Número de clientes WebSocket conectados
        can_resume:
          type: boolean
        started_at:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        last_access_at:
          type: string
          format: date-time

    TerminalListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Terminal'

    TerminalResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Terminal'

    SnapshotResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            content:
              type: string
              description: Contenido de la pantalla como texto
            display:
              type: array
              items:
                type: string
              description: Líneas de la pantalla
            cursor_x:
              type: integer
            cursor_y:
              type: integer
            width:
              type: integer
            height:
              type: integer
            in_alternate_screen:
              type: boolean
            history:
              type: array
              items:
                type: string
              description: Historial de scroll

    # -------------------------------------------------------------------------
    # Claude State
    # -------------------------------------------------------------------------
    ClaudeState:
      type: string
      enum:
        - unknown
        - waiting_input
        - generating
        - permission_prompt
        - tool_running
        - background_task
        - error
        - exited
      description: |
        Estado actual de Claude:
        - `unknown`: Estado inicial/desconocido
        - `waiting_input`: Esperando input del usuario
        - `generating`: Generando respuesta
        - `permission_prompt`: Solicitando permiso
        - `tool_running`: Ejecutando herramienta
        - `background_task`: Tarea en background
        - `error`: Error detectado
        - `exited`: Sesión terminada

    ClaudeMode:
      type: string
      enum: [normal, vim, plan, compact]
      description: Modo de edición actual

    ClaudeStateInfo:
      type: object
      properties:
        state:
          $ref: '#/components/schemas/ClaudeState'
        mode:
          $ref: '#/components/schemas/ClaudeMode'
        vim_sub_mode:
          type: string
          enum: [insert, normal, visual, command]
        permission_mode:
          type: string
          enum: [default, plan, acceptEdits, dontAsk, bypassPermissions]
        is_generating:
          type: boolean
        pending_permission:
          type: boolean
        pending_tool:
          type: string
        last_slash_command:
          type: string
        last_tool_used:
          type: string
        tokens_estimated:
          type: integer
        cost_estimated:
          type: number
          format: float
        background_tasks:
          type: array
          items:
            type: string
        last_checkpoint_id:
          type: string
        checkpoint_count:
          type: integer
        can_rewind:
          type: boolean
        active_patterns:
          type: array
          items:
            type: string
          description: Patrones regex detectados actualmente
        recent_events:
          type: array
          items:
            $ref: '#/components/schemas/HookEvent'
        last_activity:
          type: string
          format: date-time
        state_changed_at:
          type: string
          format: date-time

    ClaudeStateResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/ClaudeStateInfo'

    Checkpoint:
      type: object
      properties:
        id:
          type: string
        timestamp:
          type: string
          format: date-time
        tool_used:
          type: string
        files_affected:
          type: array
          items:
            type: string

    CheckpointsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Checkpoint'
        meta:
          type: object
          properties:
            total:
              type: integer

    HookEventType:
      type: string
      enum:
        - PreToolUse
        - PostToolUse
        - PermissionRequest
        - UserPromptSubmit
        - Stop
        - SubagentStop
        - SessionStart
        - SessionEnd
        - Notification
        - PreCompact

    HookEvent:
      type: object
      properties:
        type:
          $ref: '#/components/schemas/HookEventType'
        tool:
          type: string
        timestamp:
          type: string
          format: date-time
        data:
          type: object
          additionalProperties: true

    EventsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/HookEvent'
        meta:
          type: object
          properties:
            total:
              type: integer

    # -------------------------------------------------------------------------
    # WebSocket Messages
    # -------------------------------------------------------------------------
    WebSocketMessage:
      oneOf:
        - $ref: '#/components/schemas/WsOutputMessage'
        - $ref: '#/components/schemas/WsClaudeEventMessage'
        - $ref: '#/components/schemas/WsSnapshotMessage'
        - $ref: '#/components/schemas/WsClosedMessage'
      discriminator:
        propertyName: type
        mapping:
          output: '#/components/schemas/WsOutputMessage'
          'claude:event': '#/components/schemas/WsClaudeEventMessage'
          snapshot: '#/components/schemas/WsSnapshotMessage'
          closed: '#/components/schemas/WsClosedMessage'

    WsOutputMessage:
      type: object
      required: [type, data]
      properties:
        type:
          type: string
          enum: [output]
        data:
          type: string
          description: Salida raw de la terminal

    WsClaudeEventMessage:
      type: object
      required: [type, event_type, data, timestamp]
      properties:
        type:
          type: string
          enum: ['claude:event']
        event_type:
          type: string
          enum: [state, permission, command, checkpoint, tool]
        data:
          oneOf:
            - $ref: '#/components/schemas/StateChangeData'
            - $ref: '#/components/schemas/PermissionData'
            - $ref: '#/components/schemas/SlashCommandData'
            - $ref: '#/components/schemas/Checkpoint'
            - $ref: '#/components/schemas/ToolUseData'
        timestamp:
          type: string
          format: date-time

    StateChangeData:
      type: object
      properties:
        old_state:
          $ref: '#/components/schemas/ClaudeState'
        new_state:
          $ref: '#/components/schemas/ClaudeState'

    PermissionData:
      type: object
      properties:
        tool:
          type: string
          description: Herramienta solicitando permiso

    SlashCommandData:
      type: object
      properties:
        command:
          type: string
          description: Nombre del slash command (sin /)
        args:
          type: string
          description: Argumentos del comando

    ToolUseData:
      type: object
      properties:
        tool:
          type: string
          description: Nombre de la herramienta
        phase:
          type: string
          enum: [pre, post]
          description: Fase de uso (antes o después)

    WsSnapshotMessage:
      type: object
      required: [type, snapshot]
      properties:
        type:
          type: string
          enum: [snapshot]
        snapshot:
          type: object
          properties:
            display:
              type: array
              items:
                type: string
            cursor:
              type: object
              properties:
                x:
                  type: integer
                y:
                  type: integer
            size:
              type: object
              properties:
                width:
                  type: integer
                height:
                  type: integer
            in_alternate_screen:
              type: boolean

    WsClosedMessage:
      type: object
      required: [type, message]
      properties:
        type:
          type: string
          enum: [closed, shutdown]
        message:
          type: string

    WsInputMessage:
      type: object
      required: [type, data]
      properties:
        type:
          type: string
          enum: [input]
        data:
          type: string
          description: Input a enviar a la terminal

    WsResizeMessage:
      type: object
      required: [type, rows, cols]
      properties:
        type:
          type: string
          enum: [resize]
        rows:
          type: integer
        cols:
          type: integer

    # -------------------------------------------------------------------------
    # Jobs
    # -------------------------------------------------------------------------
    JobStatus:
      type: string
      enum:
        - pending
        - queued
        - running
        - paused
        - completed
        - failed
        - archived
      description: |
        Estado del job:
        - `pending`: Creado, esperando inicio
        - `queued`: En cola para ejecución
        - `running`: En ejecución
        - `paused`: Pausado
        - `completed`: Completado exitosamente
        - `failed`: Falló
        - `archived`: Archivado

    JobConfig:
      type: object
      required: [name, prompt]
      properties:
        name:
          type: string
          description: Nombre del job
        prompt:
          type: string
          description: Prompt inicial para Claude
        model:
          type: string
          description: Modelo de Claude
        system_prompt:
          type: string
          description: System prompt personalizado
        permission_mode:
          type: string
          enum: [default, plan, acceptEdits, dontAsk, bypassPermissions]
        max_turns:
          type: integer
          description: Máximo de turnos de conversación
        timeout:
          type: integer
          description: Timeout en segundos
        schedule:
          type: string
          description: Cron expression para programación

    Job:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        root_path:
          type: string
        prompt:
          type: string
        status:
          $ref: '#/components/schemas/JobStatus'
        session_id:
          type: string
          format: uuid
        terminal_id:
          type: string
          format: uuid
        model:
          type: string
        error:
          type: string
        retries:
          type: integer
        max_retries:
          type: integer
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    JobListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Job'
        meta:
          type: object
          properties:
            total:
              type: integer
            by_status:
              type: object
              additionalProperties:
                type: integer

    JobResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          $ref: '#/components/schemas/Job'

    JobAction:
      type: object
      properties:
        action:
          type: string
          enum: [create, start, pause, resume, stop, complete, fail, retry, archive, discard]
        timestamp:
          type: string
          format: date-time
        from_status:
          $ref: '#/components/schemas/JobStatus'
        to_status:
          $ref: '#/components/schemas/JobStatus'
        message:
          type: string

    JobActionsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/JobAction'

    # -------------------------------------------------------------------------
    # Analytics
    # -------------------------------------------------------------------------
    GlobalAnalyticsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            total_sessions:
              type: integer
            total_messages:
              type: integer
            total_tokens:
              type: integer
            total_cost:
              type: number
              format: float
            session_roots_count:
              type: integer
            active_terminals:
              type: integer
            jobs_by_status:
              type: object
              additionalProperties:
                type: integer
            usage_by_day:
              type: array
              items:
                type: object
                properties:
                  date:
                    type: string
                    format: date
                  sessions:
                    type: integer
                  tokens:
                    type: integer
                  cost:
                    type: number

    SessionRootAnalyticsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            root_path:
              type: string
            session_count:
              type: integer
            message_count:
              type: integer
            total_tokens:
              type: integer
            total_cost:
              type: number
              format: float
            last_activity:
              type: string
              format: date-time
            most_used_model:
              type: string
            usage_by_day:
              type: array
              items:
                type: object
                properties:
                  date:
                    type: string
                    format: date
                  sessions:
                    type: integer
                  tokens:
                    type: integer

    CacheStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            entries:
              type: integer
            size_bytes:
              type: integer
            hit_rate:
              type: number
              format: float
            oldest_entry:
              type: string
              format: date-time

    # -------------------------------------------------------------------------
    # Filesystem
    # -------------------------------------------------------------------------
    DirectoryEntry:
      type: object
      properties:
        name:
          type: string
        path:
          type: string
        is_dir:
          type: boolean
        size:
          type: integer
          format: int64

    DirectoryListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/DirectoryEntry'
